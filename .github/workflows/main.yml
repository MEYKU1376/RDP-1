name: Windows-Tailscale-HighSpeed

on:
  workflow_dispatch:

jobs:
  rdp-highspeed:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: 1. Optimasi Kernel & Latensi
        run: |
          # Set Power Plan ke High Performance
          powercfg /s 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
          
          # Matikan Server Manager agar startup lebih cepat
          $reg = "HKLM:\SOFTWARE\Microsoft\ServerManager"
          if (!(Test-Path $reg)) { New-Item -Path $reg -Force }
          Set-ItemProperty -Path $reg -Name "DoNotOpenServerManagerAtLogon" -Value 1
          
          # Optimasi TCP Stack untuk latensi rendah
          netsh int tcp set global autotuninglevel=normal
          netsh int tcp set global chimney=enabled
          Write-Host "âœ… Optimasi Performa Selesai."

      - name: 2. Aktifkan Remote Desktop (RDP)
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1

      - name: 3. Instalasi Tailscale
        run: |
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $out = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $url -OutFile $out
          Start-Process msiexec.exe -ArgumentList "/i $out /quiet /norestart" -Wait

      - name: 4. Hubungkan ke Tailscale (Mode Ephemeral)
        run: |
          # Menggunakan Auth Key dari Secrets
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=vps-highspeed --accept-dns=false
          $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          echo "TS_IP=$ip" >> $env:GITHUB_ENV

      - name: 5. Buat Akun Admin
        run: |
          $user = "AdminPro"
          $pass = "KecepatanTinggi2026"
          net user $user $pass /add
          net localgroup administrators $user /add
          Write-Host "âœ… User: $user | Pass: $pass"

      - name: 6. Informasi Detail
        run: |
          Write-Host "`n==========================================" -ForegroundColor Cyan
          Write-Host "ðŸš€ TAILSCALE RDP HIGH SPEED READY" -ForegroundColor Cyan
          Write-Host "=========================================="
          Write-Host "IP TAILSCALE : $env:TS_IP" -ForegroundColor Yellow
          Write-Host "USERNAME     : AdminPro" -ForegroundColor Yellow
          Write-Host "PASSWORD     : KecepatanTinggi2026" -ForegroundColor Yellow
          Write-Host "REGION       : Singapore (Auto-DERP)"
          Write-Host "=========================================="

      - name: 7. Menjaga Sesi
        run: |
          while ($true) {
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Koneksi Stabil - CPU Ready..."
            Start-Sleep -Seconds 300
          }
